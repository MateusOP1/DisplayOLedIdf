#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include <esp_err.h>
#include "esp_system.h"
#include "esp_spi_flash.h"
#include "esp_log.h"

#include <driver/adc.h>
#include <esp_adc_cal.h>

#include "ssd1306.h"
#include "font8x8_basic.h"



#define TAG "SSD1306"



esp_adc_cal_characteristics_t adc_cal; 


uint8_t logosmap [1024] = {
	// 'logosmap', 128x64px
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0x00, 0xff, 0x83, 0xe7, 0x80, 0x00, 0xf6, 0xff, 0xff, 0x9f, 0xe1, 0x38, 0xe3, 0xff, 
  0xff, 0xe0, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x03, 0x80, 0x00, 0x00, 0x3f, 
  0xff, 0xe0, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x30, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x1f, 
  0xff, 0xc0, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x1f, 
  0xff, 0xc0, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x30, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x1f, 
  0xff, 0xc0, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x30, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x1f, 
  0xff, 0xc0, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x30, 0x00, 0x00, 0x02, 0x00, 0x0f, 0x00, 0x1f, 
  0xff, 0x80, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x30, 0x00, 0x00, 0x02, 0x00, 0xff, 0xe0, 0x1f, 
  0xff, 0x80, 0x3e, 0x00, 0xfc, 0x00, 0x00, 0x80, 0x3e, 0x00, 0x28, 0x02, 0x03, 0x80, 0x70, 0x3f, 
  0xff, 0x80, 0x7f, 0xff, 0xfc, 0x03, 0x00, 0x80, 0x3f, 0xff, 0xfc, 0x02, 0x0e, 0x00, 0x1c, 0x3f, 
  0xff, 0x80, 0x00, 0x00, 0x1c, 0x02, 0x01, 0x80, 0x70, 0x00, 0x00, 0x02, 0x18, 0x7f, 0x0c, 0x3f, 
  0xff, 0x80, 0x00, 0x00, 0x0c, 0x02, 0x01, 0x80, 0x40, 0x00, 0x00, 0x06, 0x31, 0xe3, 0xc6, 0x3f, 
  0xff, 0x80, 0x00, 0x00, 0x08, 0x02, 0x01, 0x80, 0x40, 0x00, 0x00, 0x04, 0x67, 0x00, 0x62, 0x3f, 
  0xff, 0x80, 0x00, 0x00, 0x08, 0x06, 0x01, 0x80, 0x40, 0x00, 0x00, 0x04, 0x0c, 0x18, 0x30, 0x3f, 
  0xff, 0x80, 0x00, 0x00, 0x08, 0x06, 0x01, 0x80, 0x40, 0x00, 0x00, 0x04, 0x08, 0xfe, 0x30, 0x3f, 
  0xff, 0x00, 0x00, 0x00, 0x08, 0x06, 0x01, 0x80, 0x00, 0x00, 0x00, 0x04, 0x01, 0x83, 0x00, 0x7f, 
  0xff, 0x80, 0x00, 0x00, 0x08, 0x06, 0x01, 0x00, 0x80, 0x00, 0x00, 0x04, 0x03, 0x01, 0x80, 0x7f, 
  0xff, 0xc0, 0x00, 0x00, 0x08, 0x06, 0x01, 0x00, 0x80, 0x00, 0x00, 0x04, 0x00, 0x38, 0x00, 0x7f, 
  0xff, 0xff, 0xff, 0xe0, 0x08, 0x04, 0x03, 0x00, 0x80, 0x7f, 0xf8, 0x0c, 0x00, 0x78, 0x00, 0x7f, 
  0xff, 0xff, 0xff, 0xe0, 0x18, 0x04, 0x03, 0x00, 0x80, 0x7f, 0xf0, 0x08, 0x00, 0xf8, 0x00, 0x7f, 
  0xff, 0x00, 0x00, 0x00, 0x10, 0x0c, 0x03, 0x00, 0x80, 0x00, 0x00, 0x08, 0x00, 0xf8, 0x00, 0x7f, 
  0xff, 0x00, 0x00, 0x00, 0x10, 0x0c, 0x03, 0x00, 0x80, 0x00, 0x00, 0x08, 0x00, 0x70, 0x00, 0x7f, 
  0xfe, 0x00, 0x00, 0x00, 0x10, 0x0c, 0x03, 0x00, 0x80, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0xff, 
  0xfe, 0x00, 0x00, 0x00, 0x10, 0x0c, 0x02, 0x01, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0xff, 
  0xfe, 0x00, 0x00, 0x00, 0x30, 0x08, 0x06, 0x01, 0x00, 0x00, 0x00, 0x18, 0x00, 0x00, 0x00, 0xff, 
  0xfe, 0x00, 0x00, 0x00, 0x20, 0x18, 0x06, 0x01, 0x00, 0x00, 0x00, 0x18, 0x00, 0x00, 0x00, 0xff, 
  0xff, 0x00, 0x00, 0x00, 0x40, 0x18, 0x0e, 0x03, 0x80, 0x00, 0x00, 0x10, 0x00, 0x00, 0x01, 0xff, 
  0xff, 0xc0, 0x02, 0x07, 0xc0, 0xf8, 0x7e, 0x0f, 0xe0, 0x00, 0x00, 0xf0, 0x00, 0x00, 0x0f, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x0f, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0x9f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x0f, 0xff, 0xff, 0xff, 
  0xfc, 0x08, 0xa4, 0x14, 0x00, 0x00, 0x00, 0xda, 0x00, 0x01, 0x00, 0x30, 0x0f, 0xff, 0xff, 0xff, 
  0xfc, 0x00, 0x85, 0x10, 0x08, 0x00, 0x48, 0x58, 0x00, 0x00, 0x24, 0x30, 0x0f, 0xff, 0xff, 0xff, 
  0xfc, 0x00, 0x04, 0x10, 0x00, 0x00, 0x00, 0x98, 0x80, 0x10, 0x00, 0x60, 0x1f, 0xff, 0xff, 0xff, 
  0xfc, 0x00, 0x04, 0x74, 0x0c, 0x00, 0x0c, 0x98, 0x86, 0x01, 0x02, 0x60, 0x1f, 0xff, 0xff, 0xff, 
  0xff, 0xfe, 0xff, 0xef, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x1f, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0x83, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x1f, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xb9, 0xff, 0xff, 0xfe, 0x18, 0x00, 0x00, 0xff, 0xe0, 0x3f, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0x38, 0x03, 0xff, 0xfe, 0x10, 0x02, 0x81, 0xc7, 0xc0, 0x7f, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0x39, 0xb1, 0xff, 0xfe, 0x10, 0x0a, 0x41, 0x83, 0x83, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0x83, 0xfc, 0x00, 0x5e, 0x16, 0x00, 0x01, 0x81, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xc7, 0xbe, 0x00, 0x07, 0xff, 0xff, 0xff, 0x83, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0x0f, 0xff, 0xf7, 0xff, 0xff, 0xff, 0x83, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xfe, 0x00, 0x00, 0x1b, 0xff, 0xff, 0xff, 0x07, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xfe, 0x00, 0x00, 0x0d, 0xff, 0xff, 0xfe, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xfe, 0x0f, 0xff, 0xe6, 0x7f, 0xff, 0xf8, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0x0f, 0xff, 0xf3, 0x00, 0x00, 0x01, 0xf3, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf9, 0xff, 0xff, 0xff, 0xc1, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc1, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe1, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff
};



         
        



void app_main(void)
{  
    adc1_config_width(ADC_WIDTH_12Bit);
          adc1_config_channel_atten(ADC1_CHANNEL_6,ADC_ATTEN_11db);

            esp_adc_cal_value_t adc_type = esp_adc_cal_characterize(ADC_UNIT_1, ADC_ATTEN_DB_11, ADC_WIDTH_BIT_12, 1100, &adc_cal);//Inicializa a estrutura de calibracao
 
        if (adc_type == ESP_ADC_CAL_VAL_EFUSE_VREF)
           {
              ESP_LOGI("ADC CAL", "Vref eFuse encontrado: %umV", adc_cal.vref);
            }
            else if (adc_type == ESP_ADC_CAL_VAL_EFUSE_TP)
            {
              ESP_LOGI("ADC CAL", "Two Point eFuse encontrado");
            }
             else
            {
             ESP_LOGW("ADC CAL", "Nada encontrado, utilizando Vref padrao: %umV", adc_cal.vref);
            }

	
SSD1306_t dev;

	ESP_LOGI(TAG, "INTERFACE is i2c");
	ESP_LOGI(TAG, "CONFIG_SDA_GPIO=%d",CONFIG_SDA_GPIO);
	ESP_LOGI(TAG, "CONFIG_SCL_GPIO=%d",CONFIG_SCL_GPIO);
	ESP_LOGI(TAG, "CONFIG_RESET_GPIO=%d",CONFIG_RESET_GPIO);
	i2c_master_init(&dev, CONFIG_SDA_GPIO, CONFIG_SCL_GPIO, CONFIG_RESET_GPIO);
    ESP_LOGI(TAG, "Panel is 128x64");
	ssd1306_init(&dev, 128, 64);
    ssd1306_contrast(&dev, 0xff);
    while(1) {



         uint32_t voltage = 0;
        for (int i = 0; i < 100; i++)
        {
            voltage += adc1_get_raw(ADC1_CHANNEL_6);//Obtem o valor RAW do ADC
            ets_delay_us(30);
        }
        voltage /= 100;
 
 
        voltage = esp_adc_cal_raw_to_voltage(voltage, &adc_cal);//Converte e calibra o valor lido (RAW) para mV
        ESP_LOGI("ADC CAL", "Read mV: %u", voltage);//Mostra a leitura calibrada no Serial Monitor
 
        ssd1306_clear_screen(&dev, false);
        ssd1306_display_text(&dev, 0, "Mateus", 14, true);
 
        vTaskDelay(pdMS_TO_TICKS(5000));//Delay 1seg

	    ssd1306_clear_screen(&dev, false);
        ssd1306_bitmaps(&dev, 0, 0, logosmap , 128, 64, false);
		vTaskDelay(5000 / portTICK_PERIOD_MS);

	}
	
}
